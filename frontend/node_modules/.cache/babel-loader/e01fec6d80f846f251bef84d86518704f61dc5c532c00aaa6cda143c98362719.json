{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nimport * as ERROR_MSGS from \"../constants/error_msgs\";\nimport { BindingTypeEnum } from \"../constants/literal_types\";\nimport { getBindingDictionary } from \"../planning/planner\";\nimport { saveToScope, tryGetFromScope } from \"../scope/scope\";\nimport { isPromise } from \"../utils/async\";\nimport { getFactoryDetails, ensureFullyBound } from \"../utils/binding_utils\";\nimport { tryAndThrowErrorIfStackOverflow } from \"../utils/exceptions\";\nimport { resolveInstance } from \"./instantiation\";\nvar _resolveRequest = function (requestScope) {\n  return function (request) {\n    request.parentContext.setCurrentRequest(request);\n    var bindings = request.bindings;\n    var childRequests = request.childRequests;\n    var targetIsAnArray = request.target && request.target.isArray();\n    var targetParentIsNotAnArray = !request.parentRequest || !request.parentRequest.target || !request.target || !request.parentRequest.target.matchesArray(request.target.serviceIdentifier);\n    if (targetIsAnArray && targetParentIsNotAnArray) {\n      return childRequests.map(function (childRequest) {\n        var _f = _resolveRequest(requestScope);\n        return _f(childRequest);\n      });\n    } else {\n      if (request.target.isOptional() && bindings.length === 0) {\n        return undefined;\n      }\n      var binding = bindings[0];\n      return _resolveBinding(requestScope, request, binding);\n    }\n  };\n};\nvar _resolveFactoryFromBinding = function (binding, context) {\n  var factoryDetails = getFactoryDetails(binding);\n  return tryAndThrowErrorIfStackOverflow(function () {\n    return factoryDetails.factory.bind(binding)(context);\n  }, function () {\n    return new Error(ERROR_MSGS.CIRCULAR_DEPENDENCY_IN_FACTORY(factoryDetails.factoryType, context.currentRequest.serviceIdentifier.toString()));\n  });\n};\nvar _getResolvedFromBinding = function (requestScope, request, binding) {\n  var result;\n  var childRequests = request.childRequests;\n  ensureFullyBound(binding);\n  switch (binding.type) {\n    case BindingTypeEnum.ConstantValue:\n    case BindingTypeEnum.Function:\n      result = binding.cache;\n      break;\n    case BindingTypeEnum.Constructor:\n      result = binding.implementationType;\n      break;\n    case BindingTypeEnum.Instance:\n      result = resolveInstance(binding, binding.implementationType, childRequests, _resolveRequest(requestScope));\n      break;\n    default:\n      result = _resolveFactoryFromBinding(binding, request.parentContext);\n  }\n  return result;\n};\nvar _resolveInScope = function (requestScope, binding, resolveFromBinding) {\n  var result = tryGetFromScope(requestScope, binding);\n  if (result !== null) {\n    return result;\n  }\n  result = resolveFromBinding();\n  saveToScope(requestScope, binding, result);\n  return result;\n};\nvar _resolveBinding = function (requestScope, request, binding) {\n  return _resolveInScope(requestScope, binding, function () {\n    var result = _getResolvedFromBinding(requestScope, request, binding);\n    if (isPromise(result)) {\n      result = result.then(function (resolved) {\n        return _onActivation(request, binding, resolved);\n      });\n    } else {\n      result = _onActivation(request, binding, result);\n    }\n    return result;\n  });\n};\nfunction _onActivation(request, binding, resolved) {\n  var result = _bindingActivation(request.parentContext, binding, resolved);\n  var containersIterator = _getContainersIterator(request.parentContext.container);\n  var container;\n  var containersIteratorResult = containersIterator.next();\n  do {\n    container = containersIteratorResult.value;\n    var context_1 = request.parentContext;\n    var serviceIdentifier = request.serviceIdentifier;\n    var activationsIterator = _getContainerActivationsForService(container, serviceIdentifier);\n    if (isPromise(result)) {\n      result = _activateContainerAsync(activationsIterator, context_1, result);\n    } else {\n      result = _activateContainer(activationsIterator, context_1, result);\n    }\n    containersIteratorResult = containersIterator.next();\n  } while (containersIteratorResult.done !== true && !getBindingDictionary(container).hasKey(request.serviceIdentifier));\n  return result;\n}\nvar _bindingActivation = function (context, binding, previousResult) {\n  var result;\n  if (typeof binding.onActivation === \"function\") {\n    result = binding.onActivation(context, previousResult);\n  } else {\n    result = previousResult;\n  }\n  return result;\n};\nvar _activateContainer = function (activationsIterator, context, result) {\n  var activation = activationsIterator.next();\n  while (!activation.done) {\n    result = activation.value(context, result);\n    if (isPromise(result)) {\n      return _activateContainerAsync(activationsIterator, context, result);\n    }\n    activation = activationsIterator.next();\n  }\n  return result;\n};\nvar _activateContainerAsync = function (activationsIterator, context, resultPromise) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var result, activation;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4, resultPromise];\n        case 1:\n          result = _a.sent();\n          activation = activationsIterator.next();\n          _a.label = 2;\n        case 2:\n          if (!!activation.done) return [3, 4];\n          return [4, activation.value(context, result)];\n        case 3:\n          result = _a.sent();\n          activation = activationsIterator.next();\n          return [3, 2];\n        case 4:\n          return [2, result];\n      }\n    });\n  });\n};\nvar _getContainerActivationsForService = function (container, serviceIdentifier) {\n  var activations = container._activations;\n  return activations.hasKey(serviceIdentifier) ? activations.get(serviceIdentifier).values() : [].values();\n};\nvar _getContainersIterator = function (container) {\n  var containersStack = [container];\n  var parent = container.parent;\n  while (parent !== null) {\n    containersStack.push(parent);\n    parent = parent.parent;\n  }\n  var getNextContainer = function () {\n    var nextContainer = containersStack.pop();\n    if (nextContainer !== undefined) {\n      return {\n        done: false,\n        value: nextContainer\n      };\n    } else {\n      return {\n        done: true,\n        value: undefined\n      };\n    }\n  };\n  var containersIterator = {\n    next: getNextContainer\n  };\n  return containersIterator;\n};\nfunction resolve(context) {\n  var _f = _resolveRequest(context.plan.rootRequest.requestScope);\n  return _f(context.plan.rootRequest);\n}\nexport { resolve };","map":{"version":3,"names":["ERROR_MSGS","BindingTypeEnum","getBindingDictionary","saveToScope","tryGetFromScope","isPromise","getFactoryDetails","ensureFullyBound","tryAndThrowErrorIfStackOverflow","resolveInstance","_resolveRequest","requestScope","request","parentContext","setCurrentRequest","bindings","childRequests","targetIsAnArray","target","isArray","targetParentIsNotAnArray","parentRequest","matchesArray","serviceIdentifier","map","childRequest","_f","isOptional","length","undefined","binding","_resolveBinding","_resolveFactoryFromBinding","context","factoryDetails","factory","bind","Error","CIRCULAR_DEPENDENCY_IN_FACTORY","factoryType","currentRequest","toString","_getResolvedFromBinding","result","type","ConstantValue","Function","cache","Constructor","implementationType","Instance","_resolveInScope","resolveFromBinding","then","resolved","_onActivation","_bindingActivation","containersIterator","_getContainersIterator","container","containersIteratorResult","next","value","context_1","activationsIterator","_getContainerActivationsForService","_activateContainerAsync","_activateContainer","done","hasKey","previousResult","onActivation","activation","resultPromise","__awaiter","_a","sent","activations","_activations","get","values","containersStack","parent","push","getNextContainer","nextContainer","pop","resolve","plan","rootRequest"],"sources":["../../src/resolution/resolver.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}